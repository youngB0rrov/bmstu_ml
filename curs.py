# -*- coding: utf-8 -*-
"""Curs.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1MmTHz2iEUE8AgDOMWZyZwOTBMkuQUlIr
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
from math import ceil
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import StandardScaler
from sklearn.ensemble import RandomForestRegressor
from sklearn.metrics import mean_absolute_error, mean_squared_error, r2_score

np.random.seed(42)

# Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
dates = pd.date_range(start="2024-01-01", end="2024-03-31 23:00:00", freq='H')
df = pd.DataFrame({'datetime': dates})

# Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð¸Ð·Ð½Ð°ÐºÐ¸
df['hour'] = df['datetime'].dt.hour
df['dayofweek'] = df['datetime'].dt.dayofweek
df['day'] = df['datetime'].dt.day
df['month'] = df['datetime'].dt.month
df['is_weekend'] = df['dayofweek'].apply(lambda x: 1 if x >= 5 else 0)
df['is_peak_hour'] = df['hour'].apply(lambda h: 1 if 18 <= h <= 22 else 0)

# ÐŸÑ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ¸ / Ð¸Ð²ÐµÐ½Ñ‚Ñ‹
event_days = set(np.random.choice(df['datetime'].dt.date.unique(), size=15, replace=False))
df['is_event_day'] = df['datetime'].dt.date.apply(lambda d: 1 if d in event_days else 0)
df

# Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
def simulate_users(row):
    base = 10
    if row['is_weekend']:
        base += 10
    if row['is_peak_hour']:
        base += 20
    if row['is_event_day']:
        base += 30
    noise = np.random.normal(0, 5)
    lam = max(0, base + noise)
    return int(np.random.poisson(lam))

df['users_online'] = df.apply(simulate_users, axis=1)

# Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ‡ÐµÑÐºÐ¸Ðµ Ð¿Ñ€Ð¸Ð·Ð½Ð°ÐºÐ¸
df['prev_hour_users'] = df['users_online'].shift(1)
df['prev_2_hour_users'] = df['users_online'].shift(2)
df['prev_3_hour_users'] = df['users_online'].shift(3)
df['rolling_mean_3h'] = df['users_online'].rolling(3).mean()
df['rolling_std_3h'] = df['users_online'].rolling(3).std()

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ¾Ð²
for col in ['prev_hour_users', 'prev_2_hour_users', 'prev_3_hour_users', 'rolling_mean_3h', 'rolling_std_3h']:
    df[col].fillna(df['users_online'].mean(), inplace=True)
df

# Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ñ‡Ð°ÑÐ°Ð¼
plt.figure(figsize=(10, 4))
sns.lineplot(data=df, x="hour", y="users_online", ci=None)
plt.title("Ð¡Ñ€ÐµÐ´Ð½ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð¿Ð¾ Ñ‡Ð°ÑÐ°Ð¼")
plt.xlabel("Ð§Ð°Ñ Ð´Ð½Ñ")
plt.ylabel("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ Ð¾Ð½Ð»Ð°Ð¹Ð½")
plt.grid(True)
plt.tight_layout()
plt.show()

# Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ð´Ð½ÑÐ¼
df['date'] = df['datetime'].dt.date
daily_avg = df.groupby('date').agg({
    'users_online': 'mean',
    'is_weekend': 'max',
    'is_event_day': 'max'
}).reset_index()

plt.figure(figsize=(14, 5))
sns.scatterplot(
    data=daily_avg,
    x='date',
    y='users_online',
    hue='is_event_day',
    style='is_weekend',
    palette='deep'
)
plt.title("Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ð¾Ð½Ð»Ð°Ð¹Ð½ Ð¿Ð¾ Ð´Ð½ÑÐ¼ (Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ Ð¸ Ð¸Ð²ÐµÐ½Ñ‚Ñ‹)")
plt.xlabel("Ð”Ð°Ñ‚Ð°")
plt.ylabel("Ð¡Ñ€ÐµÐ´Ð½Ð¸Ð¹ Ð¾Ð½Ð»Ð°Ð¹Ð½")
plt.legend(title='Ð˜Ð²ÐµÐ½Ñ‚ / Ð’Ñ‹Ñ…Ð¾Ð´Ð½Ð¾Ð¹', loc='upper right')
plt.xticks(rotation=45)
plt.grid(True)
plt.tight_layout()
plt.show()

# ========== ÐžÐ±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸ ==========
# ÐŸÑ€Ð¸Ð·Ð½Ð°ÐºÐ¸
features = [
    'hour', 'dayofweek', 'is_weekend', 'is_peak_hour', 'is_event_day',
    'prev_hour_users', 'prev_2_hour_users', 'prev_3_hour_users',
    'rolling_mean_3h', 'rolling_std_3h'
]
X = df[features]
y = df['users_online']

# Ð”ÐµÐ»ÐµÐ½Ð¸Ðµ Ð½Ð° Ð²Ñ‹Ð±Ð¾Ñ€ÐºÐ¸
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# ÐœÐ°ÑÑˆÑ‚Ð°Ð±Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
scaler = StandardScaler()
X_train_scaled = scaler.fit_transform(X_train)
X_test_scaled = scaler.transform(X_test)

# ÐžÐ±ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð´ÐµÐ»Ð¸
regressor = RandomForestRegressor(n_estimators=100, random_state=42)
regressor.fit(X_train_scaled, y_train)
y_pred = regressor.predict(X_test_scaled)

# Ð Ð°ÑÑ‡Ñ‘Ñ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²
server_capacity = 20
servers_needed = [ceil(p / server_capacity) for p in y_pred]

print("ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ð¹:")
for i in range(10):
    print(f"Ð§Ð°Ñ #{i+1}: ÐŸÑ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹: {y_pred[i]:.1f} â†’ Ð½ÑƒÐ¶Ð½Ð¾ ÑÐµÑ€Ð²ÐµÑ€Ð¾Ð²: {servers_needed[i]}")

# ÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸
mae = mean_absolute_error(y_test, y_pred)
rmse = np.sqrt(mean_squared_error(y_test, y_pred))
r2 = r2_score(y_test, y_pred)

print(f"\nÐœÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¼Ð¾Ð´ÐµÐ»Ð¸:")
print(f"MAE  (ÑÑ€ÐµÐ´Ð½ÑÑ Ð°Ð±ÑÐ¾Ð»ÑŽÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°):      {mae:.2f}")
print(f"RMSE (ÑÑ€ÐµÐ´Ð½ÐµÐºÐ²Ð°Ð´Ñ€Ð°Ñ‚Ð¸Ñ‡Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°):      {rmse:.2f}")
print(f"RÂ²    (ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ Ð´ÐµÑ‚ÐµÑ€Ð¼Ð¸Ð½Ð°Ñ†Ð¸Ð¸):      {r2:.2f}")

# Ð¤Ð°ÐºÑ‚ vs ÐŸÑ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ (Ñ Ð»ÐµÐ³ÐµÐ½Ð´Ð¾Ð¹)
plt.figure(figsize=(7, 5))
sns.scatterplot(x=y_test, y=y_pred, alpha=0.5, label='ÐŸÑ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ Ð¼Ð¾Ð´ÐµÐ»Ð¸')
plt.plot(
    [y_test.min(), y_test.max()],
    [y_test.min(), y_test.max()],
    'r--',
    label='Ð˜Ð´ÐµÐ°Ð»ÑŒÐ½Ð¾Ðµ Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ðµ'
)
plt.xlabel("Ð¤Ð°ÐºÑ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹")
plt.ylabel("ÐŸÑ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð½Ð¾Ðµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹")
plt.title("Ð”ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ ÐºÐ°Ñ‡ÐµÑÑ‚Ð²Ð° Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ")
plt.legend(loc='upper left')
plt.grid(True)
plt.tight_layout()
plt.show()

# ÐžÑÑ‚Ð°Ñ‚ÐºÐ¸
residuals = y_test - y_pred
plt.figure(figsize=(7, 4))
sns.histplot(residuals, bins=40, kde=True)
plt.title("Ð Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ")
plt.xlabel("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€ÐµÐ´ÑÐºÐ°Ð·Ð°Ð½Ð¸Ñ")
plt.grid(True)
plt.tight_layout()
plt.show()

# Ð’Ð°Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð·Ð½Ð°ÐºÐ¾Ð²
importances = regressor.feature_importances_
feature_importance = pd.DataFrame({
    'feature': features,
    'importance': importances
}).sort_values(by='importance', ascending=False)

print("\n Ð’Ð°Ð¶Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¸Ð·Ð½Ð°ÐºÐ¾Ð²:")
print(feature_importance)

# Train MAE (Ð´Ð»Ñ ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ñ Ñ‚ÐµÑÑ‚Ð¾Ð¼)
y_train_pred = regressor.predict(X_train_scaled)
train_mae = mean_absolute_error(y_train, y_train_pred)
print(f"\nðŸ“„ Ð›Ð¾Ð³ Ð¾Ð±ÑƒÑ‡ÐµÐ½Ð¸Ñ:")
print(f"Train MAE: {train_mae:.2f}")
print(f"Test  MAE: {mae:.2f}")